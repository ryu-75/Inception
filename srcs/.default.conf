
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name nlorion.42.fr;

    keepalive_timeout   70;

    # New root location
    root /var/www/html;


    ssl_certificate /etc/ssl/certs/nlorion.42.fr.rsa.crt;
    ssl_certificate_key /etc/ssl/private/nlorion.42.fr.key;
    ssl_protocols TLSv1.2 TLSv.1.3;
    ssl_session_timeout 10m;

    index index.html index.htm index.php wordpress/index.php;

	location ~ [^/]\.php(/|$) {
		fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }
        # Definit le port localhost
    	fastcgi_pass wp:8081;

        # Definit un nom de fichier qui sera ajoute apres un URI se terminant par une barre oblique
    	fastcgi_index index.php;

        # Parametrage de FastCGI
    	include fastcgi_params;

        # SCRIPT_FILENAME sera egal au chemin definit ci-dessous
    	fastcgi_param SCRIPT_FILENAME /var/www/html/php$fastcgi_script_name;
    	fastcgi_param PATH_INFO $fastcgi_path_info;

        # Memoire tampon definis pour lire une reponse du serveur FastCGI
		fastcgi_buffers 8 8k;

        # Permet de lire la premiere partie de la reponse recue du serveur FastCGI
		fastcgi_buffer_size 8k;

        # Permet au client de lire l'integralite de la requete avant d'etre envoyer a un serveur FastCGI
        fastcgi_request_buffering   on;

        # Determine si les reponses du serveur FastCGI avec des codes superieurs ou egaux a 300
        # doivent etre transmises a un client ou etre interceptees et redirigees vers nginx
		fastcgi_intercept_errors off;

        # Definit un delait d'attente pour etablir une connexion avec un serveur CGI. Ne peut depasser 75 secondes.
		fastcgi_connect_timeout 60s;

        # Delai d'attente definit pour la transmission d'une requete au serveur FastCGI
		fastcgi_send_timeout 60s;

        # Delai d'attente pour lire une reponse du serveur FastCGI. Definit uniquement entre deux operations
		fastcgi_read_timeout 60s;
	}

    location / {
        autoindex on;
        try_files $uri $uri/ =404;
    }

    location / {
        return 404;
    }

    # Necessaire pour empecher la recursion du retour 404
    location = /404.html {
        internal;
    }
}
